<?php

class CST_Homepage_Headlines_Widget extends WP_Widget {

	protected $defaults = array(
		'cst_homepage_headlines_one'  => '',
		'cst_homepage_headlines_two' => '',
		'cst_homepage_headlines_three' => '',
		'cst_homepage_headlines_four' => '',
		);

	public function __construct() {

		parent::__construct(
			'cst_homepage_headlines',
			esc_html__( 'CST Homepage Headline Posts', 'chicagosuntimes-homepage' ),
			array(
				'description' => esc_html__( 'Displays The Homepage Top Headlines.', 'chicagosuntimes-homepage' ),
			)
		);

	}

	public function widget( $args, $instance ) {

		$instance = array_merge( $this->defaults, $instance );

		$headline_one   = $instance['cst_homepage_headlines_one'];
		if( $headline_one ) {
			$obj_one = \CST\Objects\Post::get_by_post_id( $headline_one );
		}
		$headline_two   = $instance['cst_homepage_headlines_two'];
		if( $headline_two ) {
			$obj_two = \CST\Objects\Post::get_by_post_id( $headline_two );
		}
		$headline_three = $instance['cst_homepage_headlines_three'];
		if( $headline_three ) {
			$obj_three = \CST\Objects\Post::get_by_post_id( $headline_three );
		}
		$headline_four  = $instance['cst_homepage_headlines_four'];
		if( $headline_four ) {
			$obj_four = \CST\Objects\Post::get_by_post_id( $headline_four );
		}
	?>
			<div class="large-4 columns headlines-top-story-image">
			    <?php if( $obj_one ) : ?>
			    	<a href="<?php echo esc_url( $obj_one->get_permalink() ); ?>">
			    		<?php if( $obj_one->get_featured_image_id() ) : ?>
			    			<?php echo $obj_one->get_featured_image_html( 'chiwire-header-large' ); ?>
			    		<?php else : ?>
			    			<img src="<?php echo esc_url( get_template_directory_uri() ); ?>/assets/images/breakingnews-filler.png" />
			    		<?php endif; ?>
			    	</a>
			    <?php endif; ?>
			</div>
			<div class="large-4 columns">
			    <ul class="headlines">
			    <?php if( $obj_one ) : ?>
			    	<li class="lead">
			    		<h2><a href="<?php echo esc_url( $obj_one->get_permalink() ); ?>"><?php echo esc_html( $obj_one->get_title() ); ?></a></h2>
			    		<p><a href="<?php echo esc_url( $obj_one->get_permalink() ); ?>"><?php echo esc_html( $obj_one->get_excerpt() ); ?></a></p>
			    		</a>
	                </li>
	            <?php endif; ?>

	            <?php if( $obj_two ) : ?>
	                <li class="secondary">    
	                    <a href="<?php echo esc_url( $obj_two->get_permalink() ); ?>">
	                        <?php echo esc_html( $obj_two->get_title() ); ?>
	                    </a>
	                </li>
	            <?php endif; ?>

	            <?php if( $obj_three ) : ?>
	                <li class="secondary">    
	                    <a href="<?php echo esc_url( $obj_three->get_permalink() ); ?>">
	                        <?php echo esc_html( $obj_three->get_title() ); ?>
	                    </a>
	                </li>
	            <?php endif; ?>

	            <?php if( $obj_four ) : ?>
	                <li class="secondary">    
	                    <a href="<?php echo esc_url( $obj_four->get_permalink() ); ?>">
	                        <?php echo esc_html( $obj_four->get_title() ); ?>
	                    </a>
	                </li>
	            <?php endif; ?>

			    </ul>
			</div>

		<?php
		echo $args['after_widget'];
	}

	public function form( $instance ) {

		$instance = array_merge( $this->defaults, $instance );

		$headline_one   = $instance['cst_homepage_headlines_one'];
		$headline_two   = $instance['cst_homepage_headlines_two'];
		$headline_three = $instance['cst_homepage_headlines_three'];
		$headline_four  = $instance['cst_homepage_headlines_four'];

		$latest_args = array(
				'posts_per_page'       => 50,
				'post_type'			   => CST()->get_post_types(),
				'post_status'		   => 'publish',
				);
		$latest_query = new WP_Query( $latest_args );
?>
	<p>
		<label for="<?php echo esc_attr( $this->get_field_id( 'cst_homepage_headlines_one' ) ); ?>"><?php esc_html_e( 'Headline One:', 'chicagosuntimes' ); ?></label>
		<select class="widefat" id="<?php echo esc_attr( $this->get_field_id( 'cst_homepage_headlines_one' ) ); ?>" name="<?php echo esc_attr( $this->get_field_name( 'cst_homepage_headlines_one' ) ); ?>">
			<option value="<?php esc_html__( 'All', 'chicagosuntimes' ); ?>">-Select-</option>
			<?php
				if( $latest_query->have_posts() ) : while( $latest_query->have_posts() ) : $latest_query->the_post();
					$obj = \CST\Objects\Post::get_by_post_id( get_the_ID() ); 
					$section = $obj->get_primary_section();
					$post_type = get_post_type( $obj->ID );
					$post_type_name = $obj->get_post_type_name( $post_type );
				?>
					<option <?php selected( get_the_ID() == $instance['cst_homepage_headlines_one'] ) ?> value="<?php echo get_the_ID(); ?>">[ <?php echo esc_html( $post_type_name ); ?>] - [<?php echo esc_html( $section->slug ); ?>] <?php echo esc_html( $obj->the_title() ); ?></option>
				<?php endwhile; endif; ?>
			?>
		</select>
	</p>
	<p>
		<label for="<?php echo esc_attr( $this->get_field_id( 'cst_homepage_headlines_two' ) ); ?>"><?php esc_html_e( 'Headline Two:', 'chicagosuntimes' ); ?></label>
		<select class="widefat" id="<?php echo esc_attr( $this->get_field_id( 'cst_homepage_headlines_two' ) ); ?>" name="<?php echo esc_attr( $this->get_field_name( 'cst_homepage_headlines_two' ) ); ?>">
			<option value="<?php esc_html__( 'All', 'chicagosuntimes' ); ?>">-Select-</option>
			<?php
				if( $latest_query->have_posts() ) : while( $latest_query->have_posts() ) : $latest_query->the_post();
					$obj = \CST\Objects\Post::get_by_post_id( get_the_ID() ); 
					$section = $obj->get_primary_section();
					$post_type = get_post_type( $obj->ID );
					$post_type_name = $obj->get_post_type_name( $post_type );
				?>
					<option <?php selected( get_the_ID() == $instance['cst_homepage_headlines_two'] ) ?> value="<?php echo get_the_ID(); ?>">[ <?php echo esc_html( $post_type_name ); ?>] - [<?php echo esc_html( $section->slug ); ?>] <?php echo esc_html( $obj->the_title() ); ?></option>
				<?php endwhile; endif; ?>
			?>
		</select>
	</p>
	<p>
		<label for="<?php echo esc_attr( $this->get_field_id( 'cst_homepage_headlines_three' ) ); ?>"><?php esc_html_e( 'Headline Three:', 'chicagosuntimes' ); ?></label>
		<select class="widefat" id="<?php echo esc_attr( $this->get_field_id( 'cst_homepage_headlines_three' ) ); ?>" name="<?php echo esc_attr( $this->get_field_name( 'cst_homepage_headlines_three' ) ); ?>">
			<option value="<?php esc_html__( 'All', 'chicagosuntimes' ); ?>">-Select-</option>
			<?php
				if( $latest_query->have_posts() ) : while( $latest_query->have_posts() ) : $latest_query->the_post();
					$obj = \CST\Objects\Post::get_by_post_id( get_the_ID() ); 
					$section = $obj->get_primary_section();
					$post_type = get_post_type( $obj->ID );
					$post_type_name = $obj->get_post_type_name( $post_type );
				?>
					<option <?php selected( get_the_ID() == $instance['cst_homepage_headlines_three'] ) ?> value="<?php echo get_the_ID(); ?>">[ <?php echo esc_html( $post_type_name ); ?>] - [<?php echo esc_html( $section->slug ); ?>] <?php echo esc_html( $obj->the_title() ); ?></option>
				<?php endwhile; endif; ?>
			?>
		</select>
	</p>
	<p>
		<label for="<?php echo esc_attr( $this->get_field_id( 'cst_homepage_headlines_four' ) ); ?>"><?php esc_html_e( 'Headline Four:', 'chicagosuntimes' ); ?></label>
		<select class="widefat" id="<?php echo esc_attr( $this->get_field_id( 'cst_homepage_headlines_four' ) ); ?>" name="<?php echo esc_attr( $this->get_field_name( 'cst_homepage_headlines_four' ) ); ?>">
			<option <?php selected( get_the_ID() == $instance['cst_homepage_headlines_four'] ) ?> value="<?php esc_html__( 'All', 'chicagosuntimes' ); ?>">-Select-</option>
			<?php
				if( $latest_query->have_posts() ) : while( $latest_query->have_posts() ) : $latest_query->the_post();
					$obj = \CST\Objects\Post::get_by_post_id( get_the_ID() ); 
					$section = $obj->get_primary_section();
					$post_type = get_post_type( $obj->ID );
					$post_type_name = $obj->get_post_type_name( $post_type );
				?>
					<option <?php selected( get_the_ID() == $instance['cst_homepage_headlines_four'] ) ?> value="<?php echo get_the_ID(); ?>">[ <?php echo esc_html( $post_type_name ); ?>] - [<?php echo esc_html( $section->slug ); ?>] <?php echo esc_html( $obj->the_title() ); ?></option>
				<?php endwhile; endif; ?>
			?>
		</select>
	</p>
<?php
	}

	public function update( $new_instance, $old_instance ) {

		$instance = $old_instance;
		$instance['cst_homepage_headlines_one'] = $new_instance['cst_homepage_headlines_one'];
		$instance['cst_homepage_headlines_two'] = $new_instance['cst_homepage_headlines_two'];
		$instance['cst_homepage_headlines_three'] = $new_instance['cst_homepage_headlines_three'];
		$instance['cst_homepage_headlines_four'] = $new_instance['cst_homepage_headlines_four'];
		return $instance;

	}

}
